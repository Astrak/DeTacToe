<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TicTacToe</title>
</head>
<body>
    <p id="log">Nothing</p>
    <div id="player">
        <p id="balance"></p>
        <p id="stats"></p>
    </div>
    <button id="connect">Connect</button>
    <div id="game-panel">
        <button id="create" style="display: none;">Start a game for 1 DGCC</button>
        <button id="cancel" style="display: none;">Cancel game</button>
        <ul id="join"></ul>
        <div id="active-game">
            <div id="offer"></div>
            <p id="game-log"></p>
            <button id="claim">Claim</button>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.4/web3.min.js"></script>
    <script>
        const contractChain = "0x1691";
        const contractAddress = "0x9f655e3E479919D8C3F465912995958aAfEb84F8";

        let web3, contract, currentAddress;
        let isPlaying, isHosting, isHosted;
        let networkIsValid = false;
        let gamesList, cancelledGames, startedGames, squaredGames;

        const activeGame = document.getElementById('active-game')
        const log = document.getElementById('log')
        const stats = document.getElementById('stats')
        const balance = document.getElementById('balance')
        const create = document.getElementById('create');
        const cancel = document.getElementById('cancel');
        const offer = document.getElementById('offer')
        const playerPanel = document.getElementById('player');
        const join = document.getElementById('join');
        const gamePanel = document.getElementById('game-panel')
        const connect = document.getElementById('connect');
        const claim = document.getElementById('claim')
        const gameLog = document.getElementById('game-log')

        window.addEventListener('load', init);

        function showActiveGame (gameHost){
            activeGame.style.display=  "block";
            contract.methods.games(gameHost).call().then(game=>{
                const gameIsStarted = !/^0x0+$/.test(game.visitor)
                cancel.style.display = gameIsStarted ? "none" : "block";
                gameLog.style.display = gameIsStarted ? "block" : "none";
                claim.style.display = gameIsStarted ? "block" : "none";
                gameLog.textContent = `You have ${isHosting? "initiated a game joined by" : "joined a game with"} ${isHosting ? game.visitor : gameHost} for ${web3.utils.fromWei(game.bet, "ether")} GDCC`;
                claim.onclick = () => contract.methods.claim(gameHost).send({from: currentAddress});
            })
        }

        function hideActiveGame (){
            activeGame.style.display="none"
        }

        function checkAccounts(accounts){
            if(networkIsValid && accounts !== undefined && accounts.length > 0){
                currentAddress = accounts[0]
                log.textContent = currentAddress;
                web3.eth.getBalance(currentAddress).then(amount=>balance.textContent = `Available: ${web3.utils.fromWei(amount, "ether")} DGCC`);
                connect.style.display = "none";
                if(contract !== undefined){
                    contract.methods.status(currentAddress).call().then(status=>{
                        stats.textContent = `Created ${status.created}, won ${status.won}, lost ${status.lost}, tie ${status.tie}`;
                        isPlaying = !/^0x0+$/.test(status.current);
                        isHosting = isPlaying && status.current === currentAddress;
                        isHosted = isPlaying && !isHosting;
                        create.style.display = !isPlaying ? "block" : "none";
                        if(isPlaying){
                            showActiveGame(status.current);
                        }else{
                            hideActiveGame();
                            cancel.style.display = "none"
                        }
                    })
                }
                updateGamePanel()
                showPlayerPanel()
            } else {
                log.textContent = "Not connected";
                balance.textContent = ""
                stats.textContent = "";
                connect.style.display = "block";
                hideGamePanel();
                hidePlayerPanel();
            }
        }

        function updateGamesList(){
            const p1 = contract.getPastEvents("Created", {fromBlock: 0, toBlock: "latest"});
            const p2 = contract.getPastEvents("Cancelled", {fromBlock: 0, toBlock: "latest"});
            const p3 = contract.getPastEvents("Started", {fromBlock: 0, toBlock: "latest"});
            Promise.all([p1, p2, p3]).then(values=>{
                gamesList = {}
                values[0].forEach(entry=>{
                    gamesList[entry.returnValues.host] === undefined ? gamesList[entry.returnValues.host] = [entry.returnValues.bet] : gamesList[entry.returnValues.host].push(entry.returnValues.bet);
                })
                cancelledGames = values[1].map(entry=>({host: entry.returnValues.host}));
                startedGames = values[2].map(entry=>({host: entry.returnValues.host, visitor: entry.returnValues.visitor}))
                cancelledGames.forEach(game=>gamesList[game.host].shift())
                startedGames.forEach(game=>gamesList[game.host].shift());
                if(gamesList[currentAddress] !== undefined && gamesList[currentAddress].length > 0){
                    offer.style.display = "block";
                    offer.textContent = `Waiting for a player to join for ${web3.utils.fromWei( gamesList[currentAddress][0], "ether")} DGCC`;
                    delete gamesList[currentAddress]
                }else{
                    offer.style.display = "none";
                }
                join.innerHTML = ""
                Object.keys(gamesList).forEach(host=>{
                    if(gamesList[host].length === 0 ){
                        return
                    }
                    const button = document.createElement('button');
                    button.innerHTML = `Join ${host} for ${web3.utils.fromWei(gamesList[host][0], "ether")} DGCC`;
                    button.onclick = () => contract.methods.join(host).send({from: currentAddress, value: gamesList[host][0]})
                    join.appendChild(button)
                })
            })
        }

        function updateGamePanel(){
            if(networkIsValid && contract !== undefined && currentAddress !== undefined){
                gamePanel.style.display = "block";
                updateGamesList();
            }
        }

        function hideGamePanel(){
            gamePanel.style.display = "none";
        }

        function hidePlayerPanel(){
            playerPanel.style.display="none";
        }

        function showPlayerPanel(){
            playerPanel.style.display='block';
        }

        function checkNetwork (chainId) {
            if(contractChain !== chainId) {
                networkIsValid = false;
                log.textContent = `Wrong network ${chainId}`
                hideGamePanel();
                hidePlayerPanel()
            } else {
                networkIsValid = true;
                web3.eth.getAccounts().then(checkAccounts);
            }
        }

        function init (){
            if(window.ethereum === undefined) {
                log.textContent = "Install Metamask"
                return
            }
            web3 = new Web3(ethereum);

            // Network
            ethereum.on('connect', e=>checkNetwork(e.chainId));
            ethereum.on('disconnect', e=>{
                networkIsValid = false; 
                log.textContent = "Connectivity issue" + e;
            });
            ethereum.on('chainChanged', checkNetwork);

            // Account
            web3.eth.getAccounts().then(checkAccounts);
            ethereum.on('accountsChanged', ()=>checkAccounts(web3.eth.accounts[0]));// web3 accounts are checksum-ed.
            connect.onclick = ()=>{ web3.eth.requestAccounts().then(checkAccounts) };
            
            // Contract
            const abi = fetch("./build/contracts/TicTacToe.json").then(r=>r.json()).then(compiledContract=>{
                contract = new web3.eth.Contract(compiledContract.abi,contractAddress);
                handleContract();
            });
        }

        function handleContract(){
            create.onclick = ()=>{ contract.methods.create().send({from: currentAddress, value: web3.utils.toWei("1", "ether")}) };
            cancel.onclick = ()=>{ contract.methods.cancel().send({from: currentAddress}) };
            contract.events.Created().on('data', ()=>checkAccounts([currentAddress]));
            contract.events.Cancelled().on('data', ()=>checkAccounts([currentAddress]));
            contract.events.Started().on('data', ()=>checkAccounts([currentAddress]));
            contract.events.Squared().on('data', ()=>checkAccounts([currentAddress]));
            updateGamePanel()
        }
    </script>
</body>
</html>